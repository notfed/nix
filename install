#!/usr/bin/env bash
set -e

# -------- Sanity checks --------

if [ "$#" -ne 1 ] ; then
    echo "usage: ./install <device-to-destroy>" 
    exit 1
fi

./format-ext4-enc $1

echo "-------- Copying NixOS configuration to '$WIPE_DEVICE' --------"

nixos-generate-config --root /mnt
cp -r configuration.nix files patches /mnt/etc/nixos/

echo "-------- Updating current OS's packages --------"

# Workaround for https://github.com/NixOS/nixpkgs/issues/126141
nix-build '<nixpkgs/nixos>' -A config.system.build.toplevel -I nixos-config=/mnt/etc/nixos/configuration.nix 

echo "-------- Installing NixOS --------"

nixos-install --root /mnt
